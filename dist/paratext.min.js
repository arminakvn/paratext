/*! paratext 03-02-2015 */
!function(a){"use strict";(function(){var b,c,d=[].slice;c=L.ParaText=L.Class.extend({includes:L.Mixin.Events,options:{field_category:""},initialize:function(a,b){var c;this.text=a,this.properties={id:0,members:[],_margin:{t:20,l:30,b:30,r:30},relations:[],edges:[],lat:0,"long":0},c=this,L.setOptions(c,b)},addTo:function(a){return a.addLayer(this),this},field_category:function(a){return this.options.field_category=a,this},makeRelations:function(){var a,b,c,d;if(""!==this.options.field_category){c=this.text,d=[];for(a in c)b=c[a],d.push(this.properties.edges.push({nodes:[a],rel_type:"internal",rel_param:b[this.options.field_category]}));return d}},find_relations:function(){},show_contexts:function(a,b){var c,d,e,f;return c=[],c.push(a[this.options.field_category]),d=this._m.containerPointToLayerPoint([L.DomEvent.getMousePosition(b).x+$(this._m.getContainer())[0].clientWidth/6,$(this._m.getContainer())[0].clientHeight/4]),f=this.makeDiv("context",d),this._d3obj?(e=this._d3obj,d3.selectAll(document.getElementsByClassName("context span")).data([]).remove()):d3.selectAll(document.getElementsByClassName("context span")).data([]).remove(),e=d3.select(f).selectAll("span").data([]).remove(),e=d3.select(f).selectAll("span").data([a.description]).enter(),console.log("_d3obj",e),e.append("span").text("").attr("class","context span").text(function(){return function(a){return a}}(this))},hide_context:function(){var a;return this._domEl&&(a=this._domEl),L.DomUtil.getStyle(a,"opacity")<.5?L.DomUtil.setOpacity(a,0):void 0},makeDiv2:function(a){var b;new(b=L.Control.extend({initialize:function(b){return function(){var c,d,e,f,g;return e="topleft",f=L.DomUtil.create("div","container "+a+"-info"),L.DomUtil.enableTextSelection(f),b._m.getContainer().getElementsByClassName("leaflet-control-container")[0].appendChild(f),g=$(L.DomUtil.get(f)),g.css("width",$(b._m.getContainer())[0].clientWidth/3),g.css("height",$(b._m.getContainer())[0].clientHeight/3),g.css("background-color","white"),L.DomUtil.setOpacity(L.DomUtil.get(f),.75),L.DomUtil.setPosition(L.DomUtil.get(f),L.point($(b._m.getContainer())[0].clientWidth/1.6,$(b._m.getContainer())[0].clientHeight/4),c=0),d=new L.PosAnimation,d.run(L.DomUtil.get(f),e,.9),f=f}}(this)}))},makeDiv:function(a,b){var c;return c=L.Control.extend({initialize:function(c){return function(){var d,e,f,g;return c._domEl?(f=c._domEl,L.DomUtil.getStyle(f,"opacity")<.5&&L.DomUtil.setOpacity(f,0)):(f=L.DomUtil.create("div","container "+a+"-info"),L.DomUtil.enableTextSelection(f),c._m.getContainer().getElementsByClassName("leaflet-control-container")[0].appendChild(f)),g=$(L.DomUtil.get(f)),g.css("width",$(c._m.getContainer())[0].clientWidth/6),g.css("height",$(c._m.getContainer())[0].clientHeight/6),g.css("background-color","white"),L.DomUtil.setOpacity(L.DomUtil.get(f),.7),L.DomUtil.setPosition(L.DomUtil.get(f),L.point($(c._m.getContainer())[0].clientWidth/2,$(c._m.getContainer())[0].clientHeight/2+$(c._m.getContainer())[0].clientHeight/4),d=0),e=new L.PosAnimation,e.run(L.DomUtil.get(f),b,.9),c._domEl=f}}(this)}),new c,this._domEl},listStacker:function(){var a,b,c,d,e,f,g,h,i;for(b=d3.selectAll(this._d3li),g=b[0],c=0,e=g.length;e>c;c++)a=g[c],console.log("each",a);for(h=b[0][0],i=[],d=0,f=h.length;f>d;d++)a=h[d],i.push(console.log(a.__data__));return i},clearMap:function(){var a,b;for(b in this._m._layers)if(null!=this._m._layers[b]._path)try{this._m.removeLayer(this._m._layers[b])}catch(c){a=c,this._m.removeLayer(this._m._layers[b]._path);continue}},vizAllLocations:function(){return this._m.on("load moveend viewreset zoomend",function(a){return function(){var b,c,d,e,f,g;for(a._polyline&&a.clearMap(),c=d3.selectAll(a._d3li),f=c[0][0],g=[],d=0,e=f.length;e>d;d++)b=f[d],g.push(a.vizLocation(b.__data__,d3.select(b).property("id").replace("line-","")));return g}}(this))},vizLocation:function(a,b){return this._m.on("moveend viewreset zoomend",function(c){return function(){var d,e;return c._polyline&&(e=c._polyline),d=[],c._m.getBounds().contains(c._m.layerPointToLatLng(c._m.latLngToLayerPoint(L.latLng(a.lat,a["long"]))))&&c._m.getBounds().contains(c._m.layerPointToLatLng(c._m.containerPointToLayerPoint([L.DomUtil.getViewportOffset(document.getElementById("line-"+b)).x+20+$(c._m.getContainer())[0].clientWidth/3,L.DomUtil.getViewportOffset(document.getElementById("line-"+b)).y])))?(d.push(c._m.layerPointToLatLng(c._m.latLngToLayerPoint(L.latLng(a.lat,a["long"])))),d.push(c._m.layerPointToLatLng(c._m.containerPointToLayerPoint([L.DomUtil.getViewportOffset(document.getElementById("line-"+b)).x+30+$(c._m.getContainer())[0].clientWidth/3,L.DomUtil.getViewportOffset(document.getElementById("line-"+b)).y])))):d=[],e=L.polyline(d,{color:"blue",opacity:.8,weight:.9}),e.on("add",function(){var a;return e.bringToFront(),a=0,setTimeout(function(){$(L.DomUtil.get(c._polyline._container)).animate({opacity:0},4e3,function(){})})}),c._polyline=e,e.addTo(c._m)}}(this)),this._m},getD3:function(){return this._count=0,this._canvas=$(".canvas"),this._width=this._canvas.width()-this.properties._margin.l-this.properties._margin.r,this._height=this._canvas.height()-this.properties._margin.t-this.properties._margin.b,this._svg=d3.select(".").append("svg").attr("width",this._width+this.properties._margin.l+this.properties._margin.r).attr("height",this._height+this.properties._margin.t+this.properties._margin.b).append("g").attr("transform","translate("+this.properties._margin.l+","+this.properties._margin.t+")"),this._svg.selectAll("text").data(this.properties.text).enter().append("text").attr("width",2400).attr("height",200).style("font-family","Impact").attr("fill","black").text(function(a){return a.description}).on("mouseover",function(){d3.select(this).transition().duration(300).style("fill","gray")}).on("mouseout",function(){d3.select(this).transition().duration(300).style("fill","black")}).transition().delay(0).duration(1).each("start",function(){d3.select(this).transition().duration(1).attr("y",30*(this._count+1)),this._count=this._count+1}).transition().duration(11).delay(1).style("opacity",1),this._count=this._count+1,this._svg},removeAnyLocation:function(){return d3.select(this._m.getPanes().overlayPane).select(".leaflet-zoom-animated").selectAll("g").data([]).exit().remove()},setViewByLocation:function(a){return this._m.setView(new L.LatLng(a.lat,a["long"]),19,{animation:!0,duration:50})},showLocation:function(a){var b;return b=[],b.push(new L.LatLng(a.lat,a["long"])),this._g=d3.select(this._m.getPanes().overlayPane).select(".leaflet-zoom-animated").selectAll("g"),this._g.data(b).enter().append("g").append("circle").attr("r",0).attr("stroke","white").attr("fill","none").attr("stroke-width","10").attr("cx",function(a){return function(b){return a._m.latLngToLayerPoint(b).x}}(this)).attr("cy",function(a){return function(b){return a._m.latLngToLayerPoint(b).y}}(this)).transition().delay(120).duration(1e3).attr("r",80).attr("stroke","gray").attr("stroke-width","1").attr("fill","none").transition().delay(120).duration(1e3).attr("r",40).attr("stroke","gray").attr("stroke-width","2").attr("fill","none")},makeMap:function(){var a,b;return a=$("body").append("<div id='map'></div>"),L.mapbox.accessToken="pk.eyJ1IjoiYXJtaW5hdm4iLCJhIjoiSTFteE9EOCJ9.iDzgmNaITa0-q-H_jw1lJw",this._m=L.mapbox.map("map","arminavn.ib1f592g",{zoomAnimation:!0,zoomAnimationThreshold:4,inertiaDeceleration:4e3,animate:!0,duration:1.75,easeLinearity:.1}),this._m.setView([42.34,-71.12],13),this._m.boxZoom.enable(),this._m.scrollWheelZoom.disable(),b=L.Control.extend({options:{position:"topleft"},onAdd:function(a){return function(b){var c;return a._m=b,a._textDomEl=L.DomUtil.create("div","container paratext-info"),a._el=L.DomUtil.create("svg","svg"),a._m.getPanes().overlayPane.appendChild(a._el),L.DomUtil.enableTextSelection(a._textDomEl),a._m.getPanes().overlayPane.appendChild(a._textDomEl),a._textDomObj=$(L.DomUtil.get(a._textDomEl)),a._textDomObj.css("width",$(a._m.getContainer())[0].clientWidth/3),a._textDomObj.css("height",$(a._m.getContainer())[0].clientHeight),a._textDomObj.css("background-color","white"),a._textDomObj.css("overflow","scroll"),L.DomUtil.setOpacity(L.DomUtil.get(a._textDomEl),.8),void 0===a._viewSet&&(a._viewSet=a._m.getCenter()),L.DomUtil.setPosition(L.DomUtil.get(a._textDomEl),L.point(40,-65),c=0),a._d3text=d3.select(".paratext-info").append("ul").style("list-style-type","none").style("padding-left","0px").attr("width",$(a._m.getContainer())[0].clientWidth/3).attr("height",$(a._m.getContainer())[0].clientHeight-80),a._d3li=a._d3text.selectAll("li").data(a.text).enter().append("li"),a._d3li.style("font-family","Helvetica").style("line-height","2").style("border","2px solid gray").style("margin-top","10px").style("padding-right","20px").style("padding-left","40px").attr("id",function(a,b){return"line-"+b}).text(function(b,c){var d;return a._leafletli=L.DomUtil.get("line-"+c),d=void 0,L.DomEvent.addListener(a._leafletli,"click",function(c){return c.stopPropagation(),a.removeAnyLocation(),a.setViewByLocation(b),a.showLocation(b),void 0===a._viewSet?a._viewSet=a._m.getCenter():void 0}),L.DomEvent.addListener(a._leafletli,"mouseout",function(b){return d=0,b.stopPropagation(),setTimeout(function(){$(L.DomUtil.get(a._domEl)).animate({opacity:0},100,function(){})}),a.removeAnyLocation()}),L.DomEvent.addListener(a._leafletli,"mouseover",function(c){$(this).css("cursor","pointer"),c.stopPropagation(),a.clearMap(),a.removeAnyLocation(),d=setTimeout(function(){return a._m._initPathRoot(),0!==d&&(console.log("d",b),a.setViewByLocation(b),a.showLocation(b),d=0,void 0===a._viewSet)?a._viewSet=a._m.getCenter():void 0},900)},function(){}),b.description}).style("font-size","16px").style("color","rgb(72,72,72)").on("mouseover",function(){$(this).css("cursor","pointer"),d3.select(this).transition().duration(0).style("color","black").style("background-color","rgb(208,208,208) ").style("opacity",1)}).on("mouseout",function(){d3.select(this).transition().duration(1e3).style("color","rgb(72,72,72)").style("background-color","white").style("opacity",1)}).transition().duration(1).delay(1).style("opacity",1),a._m.whenReady(function(){return a._m.setView([42.34,-71.12],13)}),a._textDomEl}}(this),onSetView:function(a){return function(b){return a._m=b}}(this)}),this._m.addControl(new b),this._m.on("viewreset",function(a){return function(){return a.vizAllLocations()}}(this)),this._m.on("moveend",function(a){return function(){return a.vizAllLocations()}}(this)),this._m},connectRelation:function(){return this.raw_text=this.properties.text}}),L.paratext=function(a){return new L.ParaText(a)},b=function(a,b,c){return a[c]=function(){var e;return e=1<=arguments.length?d.call(arguments,0):[],0===e.length?a[b][c]:(a[b][c]=e[0],a)}},c.VERSION="0.0.0",a.paratext=c}).call(this)}(this);